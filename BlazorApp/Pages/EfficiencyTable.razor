@using BlazorApp.Data
@using System.Reflection.Metadata
@using System.Net.Sockets
@using Radzen.Blazor
@using Radzen.Blazor.Rendering


@if (_dataStorageList == null)
{
    <p>Loading ....</p>
}
else
{
    <div class="efficiency-table-styling">
    <RadzenDataGrid @ref="EfficiencyDataGrid" AllowFiltering="true" AllowColumnResize="true" FilterMode="FilterMode.Advanced" PageSize="999999"
                    AllowPaging="false" AllowSorting="true" Data="@_dataStorageList" TItem="EfficiencyData"
                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                    LogicalFilterOperator="LogicalFilterOperator.Or" CellRender="@CellRender">
        <Columns>
            <RadzenDataGridColumn TItem="EfficiencyData" Property="ManagerName" Filterable="true"
                                  Title="MANAGER" Frozen="false" Width="400px" Sortable="false">
                <Template Context="data">
                    <div style="display: grid; width: 200px; max-width: 200px; text-overflow: ellipsis; white-space: nowrap;" title="@data.ManagerName">
                        @if (data.RowsRead == 0 && data.RowsWritten == 0)
                        {
                            <span class="low-score-styling">@Utility.ShortenManagerName(data.ManagerName)</span>
                        }
                        else
                        {
                            <span style="color: #FFFFFF; ">@Utility.ShortenManagerName(data.ManagerName)</span>
                        }
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="EfficiencyData" Property="EfficiencyScore" Filterable="false"
                                  Title="SCORE" Frozen="false" Width="100px">
                <Template Context="data">
                    <div style="display: grid; width: 60px; max-width: 60px; text-overflow: ellipsis; white-space: nowrap;" title="@data.EfficiencyScore">
                        @if (data.RowsRead == 0 && data.RowsWritten == 0)
                        {
                            <span class="low-score-styling">@data.EfficiencyScore</span>
                        }
                        else
                        {
                            <span style="color: #FFFFFF;">@data.EfficiencyScore</span>
                        }
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="EfficiencyData" Property="TimeFinished" Filterable="false"
                                  Title="ENDTIME" Frozen="false" Width="300px" Sortable="false">
                <Template Context="data">
                    <div style="display: grid; width: 150px; max-width: 150px; text-overflow: ellipsis; white-space: nowrap;" title="@data.TimeFinished">
                        @if (data.RowsRead == 0 && data.RowsWritten == 0)
                        {
                            <span class="low-score-styling">@data.TimeFinished</span>
                        }
                        else
                        {
                            <span style="color: #FFFFFF;">@data.TimeFinished</span>
                        }
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="EfficiencyData" Property="RowsRead" Filterable="false"
                                  Title="Read" Frozen="false" Width="100px" Sortable="false">
                <Template Context="data">
                    <div style="display: grid; width: 75px; max-width: 75px; text-overflow: ellipsis; white-space: nowrap;" title="@data.RowsRead">
                        @if (data.RowsRead == 0 && data.RowsWritten == 0)
                        {
                            <span class="low-score-styling">@data.RowsRead</span>
                        }
                        else
                        {
                            <span style="color: #FFFFFF;">@data.RowsRead</span>
                        }
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="EfficiencyData" Property="RowsWritten" Filterable="false"
                                  Title="Written" Frozen="false" Width="100px" Sortable="false">
                <Template Context="data">
                    <div style="display: grid; width: 75px; max-width: 75px; text-overflow: ellipsis; white-space: nowrap;" title="@data.RowsWritten">
                        @if (data.RowsRead == 0 && data.RowsWritten == 0)
                        {
                            <span class="low-score-styling">@data.RowsWritten</span>
                        }
                        else
                        {
                            <span style="color: #FFFFFF;">@data.RowsWritten</span>
                        }
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="EfficiencyData" Property="TimeRan" Filterable="false"
                                  Title="Time ran" Frozen="false" Width="100px" Sortable="false">
                <Template Context="data">
                    <div style="display: grid; width: 50px; max-width: 50px; text-overflow: ellipsis; white-space: nowrap;" title="@data.TimeRan">
                        @if (data.RowsRead == 0 && data.RowsWritten == 0)
                        {
                            <span style="text-align: right" class="low-score-styling">@Utility.FormatTime(data.TimeRan)</span>
                        }
                        else
                        {
                            <span style="color: #FFFFFF; text-align: right;">@Utility.FormatTime(data.TimeRan)</span>
                        }
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="EfficiencyData" Property="AvgCpu" Filterable="false"
                                  Title="CPU" Frozen="false" Width="100px" Sortable="false">
                <Template Context="data">
                    <div style="display: grid; width: 50px; max-width: 50px; text-overflow: ellipsis; white-space: nowrap;" title="@data.AvgCpu">
                        @if (data.RowsRead == 0 && data.RowsWritten == 0)
                        {
                            <span style="text-align: right" class="low-score-styling">@data.AvgCpu%</span>
                        }
                        else
                        {
                            <span style="color: #FFFFFF; text-align: right">@data.AvgCpu%</span>
                        }
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="EfficiencyData" Property="AvgMemory" Filterable="false"
                                  Title="Memory" Frozen="false" Width="100px" Sortable="false">
                <Template Context="data">
                    <div style="display: grid; width: 50px; max-width: 50px; text-overflow: ellipsis; white-space: nowrap;" title="@data.AvgMemoryPercent">
                        @if (data.RowsRead == 0 && data.RowsWritten == 0)
                        {
                            <span style="text-align: right" class="low-score-styling">@data.AvgMemoryPercent%</span>
                        }
                        else
                        {
                            <span style="color: #FFFFFF; text-align: right">@data.AvgMemoryPercent%</span>
                        }
                    </div>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
    </div>
}

@code {
    List<EfficiencyData> _dataStorageList = new List<EfficiencyData>();
    private int currentCount = 0;
    RadzenDataGrid<EfficiencyData> EfficiencyDataGrid;
    
    protected override async Task OnInitializedAsync()
    {
        StateHasChanged();
        
        EfficiencyUpdateTriggered += async (o, args) =>
        {
            _dataStorageList.Clear();
            _dataStorageList.AddRange(args.EfficiencyDataList);
            await InvokeAsync(EfficiencyDataGrid.Reload);
            await InvokeAsync(StateHasChanged);
        };
        
        EfficiencyUpdateResseted += async (o, args) =>
        {
            _dataStorageList = null;
            await InvokeAsync(EfficiencyDataGrid.Reload);
            await InvokeAsync(StateHasChanged);
        };
    }

    //When rendering the cells, change the background color.
    void CellRender(DataGridCellRenderEventArgs<EfficiencyData> dataGridCellRenderEventArgs)
    {
        dataGridCellRenderEventArgs.Attributes.Add("style", $"background-color: #384561;");
    }
}
